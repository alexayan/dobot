<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Querying &mdash; peewee 2.6.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="peewee 2.6.1 documentation" href="../index.html" />
    <link rel="next" title="Transactions" href="transactions.html" />
    <link rel="prev" title="Models and Fields" href="models.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="transactions.html" title="Transactions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Models and Fields"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">peewee 2.6.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="querying">
<span id="id1"></span><h1>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h1>
<p>This section will cover the basic CRUD operations commonly performed on a relational database:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal"><span class="pre">Model.create()</span></code></a>, for executing <em>INSERT</em> queries.</li>
<li><a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal"><span class="pre">Model.save()</span></code></a> and <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal"><span class="pre">Model.update()</span></code></a>, for executing <em>UPDATE</em> queries.</li>
<li><a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete_instance()</span></code></a> and <a class="reference internal" href="api.html#Model.delete" title="Model.delete"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete()</span></code></a>, for executing <em>DELETE</em> queries.</li>
<li><a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal"><span class="pre">Model.select()</span></code></a>, for executing <em>SELECT</em> queries.</li>
</ul>
<div class="section" id="creating-a-new-record">
<h2>Creating a new record<a class="headerlink" href="#creating-a-new-record" title="Permalink to this headline">¶</a></h2>
<p>You can use <a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal"><span class="pre">Model.create()</span></code></a> to create a new model instance. This method accepts keyword arguments, where the keys correspond to the names of the model&#8217;s fields. A new instance is returned and a row is added to the table.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="go">&lt;__main__.User object at 0x2529350&gt;</span>
</pre></div>
</div>
<p>This will <em>INSERT</em> a new row into the database. The primary key will automatically be retrieved and stored on the model instance.</p>
<p>Alternatively, you can build up a model instance programmatically and then call <a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal"><span class="pre">save()</span></code></a>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c"># save() returns the number of rows modified.</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s">&#39;Huey&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">id</span>
<span class="go">2</span>
</pre></div>
</div>
<p>When a model has a foreign key, you can directly assign a model instance to the foreign key field when creating a new record.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">huey</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Hello!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also use the value of the related object&#8217;s primary key:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Hello again!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you simply wish to insert data and do not need to create a model instance, you can use <a class="reference internal" href="api.html#Model.insert" title="Model.insert"><code class="xref py py-meth docutils literal"><span class="pre">Model.insert()</span></code></a>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;Mickey&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="go">3</span>
</pre></div>
</div>
<p>After executing the insert query, the primary key of the new row is returned.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are several ways you can speed up bulk insert operations. Check out
the <a class="reference internal" href="#bulk-inserts"><span>Bulk inserts</span></a> recipe section for more information.</p>
</div>
</div>
<div class="section" id="bulk-inserts">
<span id="id2"></span><h2>Bulk inserts<a class="headerlink" href="#bulk-inserts" title="Permalink to this headline">¶</a></h2>
<p>There are a couple of ways you can load lots of data quickly. The naive approach is to simply call <a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal"><span class="pre">Model.create()</span></code></a> in a loop:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data_source</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">&#39;field1&#39;</span><span class="p">:</span> <span class="s">&#39;val1-1&#39;</span><span class="p">,</span> <span class="s">&#39;field2&#39;</span><span class="p">:</span> <span class="s">&#39;val1-2&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#39;field1&#39;</span><span class="p">:</span> <span class="s">&#39;val2-1&#39;</span><span class="p">,</span> <span class="s">&#39;field2&#39;</span><span class="p">:</span> <span class="s">&#39;val2-2&#39;</span><span class="p">},</span>
    <span class="c"># ...</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">data_source</span><span class="p">:</span>
    <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>The above approach is slow for a couple of reasons:</p>
<ol class="arabic simple">
<li>If you are using autocommit (the default), then each call to <a class="reference internal" href="api.html#Model.create" title="Model.create"><code class="xref py py-meth docutils literal"><span class="pre">create()</span></code></a> happens in its own transaction. That is going to be really slow!</li>
<li>There is a decent amount of Python logic getting in your way, and each <a class="reference internal" href="api.html#InsertQuery" title="InsertQuery"><code class="xref py py-class docutils literal"><span class="pre">InsertQuery</span></code></a> must be generated and parsed into SQL.</li>
<li>That&#8217;s a lot of data (in terms of raw bytes of SQL) you are sending to your database to parse.</li>
<li>We are retrieving the <em>last insert id</em>, which causes an additional query to be executed in some cases.</li>
</ol>
<p>You can get a <strong>very significant speedup</strong> by simply wrapping this in a <a class="reference internal" href="api.html#Database.atomic" title="Database.atomic"><code class="xref py py-meth docutils literal"><span class="pre">atomic()</span></code></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This is much faster.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">data_dict</span> <span class="ow">in</span> <span class="n">data_source</span><span class="p">:</span>
        <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code still suffers from points 2, 3 and 4. We can get another big boost by calling <a class="reference internal" href="api.html#Model.insert_many" title="Model.insert_many"><code class="xref py py-meth docutils literal"><span class="pre">insert_many()</span></code></a>. This method accepts a list of dictionaries to insert.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Fastest.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="n">Model</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>Depending on the number of rows in your data source, you may need to break it up into chunks:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Insert rows 1000 at a time.</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_source</span><span class="p">),</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">Model</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data_source</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1000</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>If the data you would like to bulk load is stored in another table, you can also create <em>INSERT</em> queries whose source is a <em>SELECT</em> query. Use the <a class="reference internal" href="api.html#Model.insert_from" title="Model.insert_from"><code class="xref py py-meth docutils literal"><span class="pre">Model.insert_from()</span></code></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">TweetArchive</span>
         <span class="o">.</span><span class="n">insert_from</span><span class="p">(</span>
             <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">message</span><span class="p">],</span>
             <span class="n">query</span><span class="o">=</span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
         <span class="o">.</span><span class="n">execute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-existing-records">
<h2>Updating existing records<a class="headerlink" href="#updating-existing-records" title="Permalink to this headline">¶</a></h2>
<p>Once a model instance has a primary key, any subsequent call to <a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal"><span class="pre">save()</span></code></a> will result in an <em>UPDATE</em> rather than another <em>INSERT</em>. The model&#8217;s primary key will not change:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c"># save() returns the number of rows modified.</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">id</span>
<span class="go">2</span>
</pre></div>
</div>
<p>If you want to update multiple records, issue an <em>UPDATE</em> query. The following example will update all <code class="docutils literal"><span class="pre">Tweet</span></code> objects, marking them as <em>published</em>, if they were created before today. <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal"><span class="pre">Model.update()</span></code></a> accepts keyword arguments where the keys correspond to the model&#8217;s field names:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">&lt;</span> <span class="n">today</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c"># Returns the number of rows that were updated.</span>
<span class="go">4</span>
</pre></div>
</div>
<p>For more information, see the documentation on <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal"><span class="pre">Model.update()</span></code></a> and <a class="reference internal" href="api.html#UpdateQuery" title="UpdateQuery"><code class="xref py py-class docutils literal"><span class="pre">UpdateQuery</span></code></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you would like more information on performing atomic updates (such as
incrementing the value of a column), check out the <a class="reference internal" href="#atomic-updates"><span>atomic update</span></a>
recipes.</p>
</div>
</div>
<div class="section" id="atomic-updates">
<span id="id3"></span><h2>Atomic updates<a class="headerlink" href="#atomic-updates" title="Permalink to this headline">¶</a></h2>
<p>Peewee allows you to perform atomic updates. Let&#8217;s suppose we need to update some counters. The naive approach would be to write something like this:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="gp">... </span>    <span class="n">stat</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Do not do this!</strong> Not only is this slow, but it is also vulnerable to race conditions if multiple processes are updating the counter at the same time.</p>
<p>Instead, you can update the counters atomically using <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal"><span class="pre">update()</span></code></a>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">counter</span><span class="o">=</span><span class="n">Stat</span><span class="o">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>You can make these update statements as complex as you like. Let&#8217;s give all our employees a bonus equal to their previous bonus plus 10% of their salary:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bonus</span><span class="o">=</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">bonus</span> <span class="o">+</span> <span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c"># Give everyone a bonus!</span>
</pre></div>
</div>
<p>We can even use a subquery to update the value of a column. Suppose we had a denormalized column on the <code class="docutils literal"><span class="pre">User</span></code> model that stored the number of tweets a user had made, and we updated this value periodically. Here is how you might write such a query:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">subquery</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">update</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">num_tweets</span><span class="o">=</span><span class="n">subquery</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">update</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="deleting-records">
<h2>Deleting records<a class="headerlink" href="#deleting-records" title="Permalink to this headline">¶</a></h2>
<p>To delete a single model instance, you can use the <a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete_instance()</span></code></a> shortcut. <a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">delete_instance()</span></code></a> will delete the given model instance and can optionally delete any dependent objects recursively (by specifying <cite>recursive=True</cite>).</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">delete_instance</span><span class="p">()</span>  <span class="c"># Returns the number of rows deleted.</span>
<span class="go">1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">UserDoesNotExist: instance matching query does not exist:</span>
<span class="go">SQL: SELECT t1.&quot;id&quot;, t1.&quot;username&quot; FROM &quot;user&quot; AS t1 WHERE t1.&quot;id&quot; = ?</span>
<span class="go">PARAMS: [1]</span>
</pre></div>
</div>
<p>To delete an arbitrary set of rows, you can issue a <em>DELETE</em> query. The following will delete all <code class="docutils literal"><span class="pre">Tweet</span></code> objects that are over one year old:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">&lt;</span> <span class="n">one_year_ago</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c"># Returns the number of rows deleted.</span>
<span class="go">7</span>
</pre></div>
</div>
<p>For more information, see the documentation on:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete_instance()</span></code></a></li>
<li><a class="reference internal" href="api.html#Model.delete" title="Model.delete"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete()</span></code></a></li>
<li><a class="reference internal" href="api.html#DeleteQuery" title="DeleteQuery"><code class="xref py py-class docutils literal"><span class="pre">DeleteQuery</span></code></a></li>
</ul>
</div>
<div class="section" id="selecting-a-single-record">
<h2>Selecting a single record<a class="headerlink" href="#selecting-a-single-record" title="Permalink to this headline">¶</a></h2>
<p>You can use the <a class="reference internal" href="api.html#Model.get" title="Model.get"><code class="xref py py-meth docutils literal"><span class="pre">Model.get()</span></code></a> method to retrieve a single instance matching the given query.</p>
<p>This method is a shortcut that calls <a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal"><span class="pre">Model.select()</span></code></a> with the given query, but limits the result set to a single row. Additionally, if no model matches the given query, a <code class="docutils literal"><span class="pre">DoesNotExist</span></code> exception will be raised.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">&lt;__main__.User object at 0x25294d0&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">username</span>
<span class="go">u&#39;Charlie&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="go">&lt;__main__.User object at 0x2529410&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;nobody&#39;</span><span class="p">)</span>
<span class="go">UserDoesNotExist: instance matching query does not exist:</span>
<span class="go">SQL: SELECT t1.&quot;id&quot;, t1.&quot;username&quot; FROM &quot;user&quot; AS t1 WHERE t1.&quot;username&quot; = ?</span>
<span class="go">PARAMS: [&#39;nobody&#39;]</span>
</pre></div>
</div>
<p>For more advanced operations, you can use <a class="reference internal" href="api.html#SelectQuery.get" title="SelectQuery.get"><code class="xref py py-meth docutils literal"><span class="pre">SelectQuery.get()</span></code></a>. The following query retrieves the latest tweet from the user named <em>charlie</em>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">Tweet</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<span class="gp">... </span> <span class="o">.</span><span class="n">get</span><span class="p">())</span>
<span class="go">&lt;__main__.Tweet object at 0x2623410&gt;</span>
</pre></div>
</div>
<p>For more information, see the documentation on:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Model.get" title="Model.get"><code class="xref py py-meth docutils literal"><span class="pre">Model.get()</span></code></a></li>
<li><a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal"><span class="pre">Model.select()</span></code></a></li>
<li><a class="reference internal" href="api.html#SelectQuery.get" title="SelectQuery.get"><code class="xref py py-meth docutils literal"><span class="pre">SelectQuery.get()</span></code></a></li>
</ul>
</div>
<div class="section" id="get-or-create">
<h2>Get or create<a class="headerlink" href="#get-or-create" title="Permalink to this headline">¶</a></h2>
<p>While peewee has a <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal"><span class="pre">get_or_create()</span></code></a> method, I do not advise you use it. The proper way to perform a <em>get or create</em> with peewee is to <em>create then get</em>, relying on database constraints to avoid duplicate records.</p>
<p>Let&#8217;s say we wish to implement registering a new user account using the <a class="reference internal" href="models.html#blog-models"><span>example User model</span></a>. The <em>User</em> model has a <em>unique</em> constraint on the username field, so we will rely on the database&#8217;s integrity guarantees to ensure we don&#8217;t end up with duplicate usernames:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
<span class="k">except</span> <span class="n">peewee</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
    <span class="c"># `username` is a unique column, so this username already exists,</span>
    <span class="c"># making it safe to call .get().</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>The above example first attempts at creation, then falls back to retrieval, relying on the database to enforce a unique constraint.</p>
<p>If you prefer to attempt to retrieve the record first, you can use <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal"><span class="pre">get_or_create()</span></code></a>. This method is implemented along the same lines as the Django function of the same name. You can use the Django-style keyword argument filters to specify your <code class="docutils literal"><span class="pre">WHERE</span></code> conditions. The function returns a 2-tuple containing the instance and a boolean value indicating if the object was created.</p>
<p>Here is how you might implement user account creation using <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal"><span class="pre">get_or_create()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">user</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose we have a different model <code class="docutils literal"><span class="pre">Person</span></code> and would like to get or create a person object. The only conditions we care about when retrieving the <code class="docutils literal"><span class="pre">Person</span></code> are their first and last names, <strong>but</strong> if we end up needing to create a new record, we will also specify their date-of-birth and favorite color:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">person</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
    <span class="n">first_name</span><span class="o">=</span><span class="n">first_name</span><span class="p">,</span>
    <span class="n">last_name</span><span class="o">=</span><span class="n">last_name</span><span class="p">,</span>
    <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;dob&#39;</span><span class="p">:</span> <span class="n">dob</span><span class="p">,</span> <span class="s">&#39;favorite_color&#39;</span><span class="p">:</span> <span class="s">&#39;green&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Any keyword argument passed to <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal"><span class="pre">get_or_create()</span></code></a> will be used in the <code class="docutils literal"><span class="pre">get()</span></code> portion of the logic, except for the <code class="docutils literal"><span class="pre">defaults</span></code> dictionary, which will be used to populate values on newly-created instances.</p>
<p>For more details check out the documentation for <a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><code class="xref py py-meth docutils literal"><span class="pre">Model.get_or_create()</span></code></a>.</p>
</div>
<div class="section" id="selecting-multiple-records">
<h2>Selecting multiple records<a class="headerlink" href="#selecting-multiple-records" title="Permalink to this headline">¶</a></h2>
<p>We can use <a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal"><span class="pre">Model.select()</span></code></a> to retrieve rows from the table. When you construct a <em>SELECT</em> query, the database will return any rows that correspond to your query. Peewee allows you to iterate over these rows, as well as use indexing and slicing operations.</p>
<p>In the following example, we will simply call <a class="reference internal" href="api.html#Model.select" title="Model.select"><code class="xref py py-meth docutils literal"><span class="pre">select()</span></code></a> and iterate over the return value, which is an instance of <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>. This will return all the rows in the <em>User</em> table:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
<span class="gp">...</span>
<span class="go">Charlie</span>
<span class="go">Huey</span>
<span class="go">Peewee</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Subsequent iterations of the same query will not hit the database as the results are cached. To disable this behavior (to reduce memory usage), call <a class="reference internal" href="api.html#SelectQuery.iterator" title="SelectQuery.iterator"><code class="xref py py-meth docutils literal"><span class="pre">SelectQuery.iterator()</span></code></a> when iterating.</p>
</div>
<p>When iterating over a model that contains a foreign key, be careful with the way you access values on related models. Accidentally resolving a foreign key or iterating over a back-reference can cause <a class="reference internal" href="#nplusone"><span>N+1 query behavior</span></a>.</p>
<p>When you create a foreign key, such as <code class="docutils literal"><span class="pre">Tweet.user</span></code>, you can use the <em>related_name</em> to create a back-reference (<code class="docutils literal"><span class="pre">User.tweets</span></code>). Back-references are exposed as <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> instances:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span>  <span class="c"># Accessing a foreign key returns the related model.</span>
<span class="go">&lt;tw.User at 0x7f3ceb017f50&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">tweets</span>  <span class="c"># Accessing a back-reference returns a query.</span>
<span class="go">&lt;SelectQuery&gt; SELECT t1.&quot;id&quot;, t1.&quot;user_id&quot;, t1.&quot;message&quot;, t1.&quot;created_date&quot;, t1.&quot;is_published&quot; FROM &quot;tweet&quot; AS t1 WHERE (t1.&quot;user_id&quot; = ?) [1]</span>
</pre></div>
</div>
<p>You can iterate over the <code class="docutils literal"><span class="pre">user.tweets</span></code> back-reference just like any other <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
<span class="gp">...</span>
<span class="go">hello world</span>
<span class="go">this is fun</span>
<span class="go">look at this picture of my food</span>
</pre></div>
</div>
</div>
<div class="section" id="filtering-records">
<h2>Filtering records<a class="headerlink" href="#filtering-records" title="Permalink to this headline">¶</a></h2>
<p>You can filter for particular records using normal python operators. Peewee supports a wide variety of <a class="reference internal" href="#query-operators"><span>query operators</span></a>.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;Charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">is_published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Charlie: hello world</span>
<span class="go">Charlie: this is fun</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">created_date</span>
<span class="gp">...</span>
<span class="go">Really old tweet 2010-01-01 00:00:00</span>
</pre></div>
</div>
<p>You can also filter across joins:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;Charlie&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
<span class="go">hello world</span>
<span class="go">this is fun</span>
<span class="go">look at this picture of my food</span>
</pre></div>
</div>
<p>If you want to express a complex query, use parentheses and python&#8217;s bitwise <em>or</em> and <em>and</em> operators:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;Charlie&#39;</span><span class="p">)</span> <span class="o">|</span>
<span class="gp">... </span>    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;Peewee Herman&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>Check out <a class="reference internal" href="#query-operators"><span>the table of query operations</span></a> to see what types of queries are possible.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>A lot of fun things can go in the where clause of a query, such as:</p>
<ul class="simple">
<li>A field expression, e.g. <code class="docutils literal"><span class="pre">User.username</span> <span class="pre">==</span> <span class="pre">'Charlie'</span></code></li>
<li>A function expression, e.g. <code class="docutils literal"><span class="pre">fn.Lower(fn.Substr(User.username,</span> <span class="pre">1,</span> <span class="pre">1))</span> <span class="pre">==</span> <span class="pre">'a'</span></code></li>
<li>A comparison of one column to another, e.g. <code class="docutils literal"><span class="pre">Employee.salary</span> <span class="pre">&lt;</span> <span class="pre">(Employee.tenure</span> <span class="pre">*</span> <span class="pre">1000)</span> <span class="pre">+</span> <span class="pre">40000</span></code></li>
</ul>
<p>You can also nest queries, for example tweets by users whose username starts with &#8220;a&#8221;:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="c"># get users whose username starts with &quot;a&quot;</span>
<span class="n">a_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>

<span class="c"># the &quot;&lt;&lt;&quot; operator signifies an &quot;IN&quot; query</span>
<span class="n">a_user_tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">&lt;&lt;</span> <span class="n">a_users</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="more-query-examples">
<h3>More query examples<a class="headerlink" href="#more-query-examples" title="Permalink to this headline">¶</a></h3>
<p>Get active users:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Get users who are either staff or superusers:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Get tweets by user named &#8220;charlie&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Get tweets by staff or superusers (assumes FK relationship):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Get tweets by staff or superusers using a subquery:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">staff_super</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">&lt;&lt;</span> <span class="n">staff_super</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sorting-records">
<h2>Sorting records<a class="headerlink" href="#sorting-records" title="Permalink to this headline">¶</a></h2>
<p>To return rows in order, use the <a class="reference internal" href="api.html#SelectQuery.order_by" title="SelectQuery.order_by"><code class="xref py py-meth docutils literal"><span class="pre">order_by()</span></code></a> method:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">pub_date</span>
<span class="gp">...</span>
<span class="go">2010-01-01 00:00:00</span>
<span class="go">2011-06-07 14:08:48</span>
<span class="go">2011-06-07 14:12:57</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">()):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">pub_date</span>
<span class="gp">...</span>
<span class="go">2011-06-07 14:12:57</span>
<span class="go">2011-06-07 14:08:48</span>
<span class="go">2010-01-01 00:00:00</span>
</pre></div>
</div>
<p>You can also use <code class="docutils literal"><span class="pre">+</span></code> and <code class="docutils literal"><span class="pre">-</span></code> prefix operators to indicate ordering:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># The following queries are equivalent:</span>
<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>

<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">-</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">)</span>  <span class="c"># Note the &quot;-&quot; prefix.</span>

<span class="c"># Similarly you can use &quot;+&quot; to indicate ascending order:</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">+</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also order across joins. Assuming you want to order tweets by the username of the author, then by created_date:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">qry</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;message&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;is_published&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;created_date&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;tweet&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;user&quot;</span> <span class="k">AS</span> <span class="n">t2</span>
  <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;created_date&quot;</span> <span class="k">DESC</span>
</pre></div>
</div>
<p>When sorting on a calculated value, you can either include the necessary SQL expressions, or reference the alias assigned to the value. Here are two examples illustrating these methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Let&#39;s start with our base query. We want to get all usernames and the number of</span>
<span class="c"># tweets they&#39;ve made. We wish to sort this list from users with most tweets to</span>
<span class="c"># users with fewest tweets.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>
</pre></div>
</div>
<p>You can order using the same COUNT expression used in the <code class="docutils literal"><span class="pre">select</span></code> clause. In the example below we are ordering by the <code class="docutils literal"><span class="pre">COUNT()</span></code> of tweet ids descending:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
</pre></div>
</div>
<p>Alternatively, you can reference the alias assigned to the calculated value in the <code class="docutils literal"><span class="pre">select</span></code> clause. This method has the benefit of being a bit easier to read. Note that we are not referring to the named alias directly, but are wrapping it using the <a class="reference internal" href="api.html#SQL" title="SQL"><code class="xref py py-class docutils literal"><span class="pre">SQL</span></code></a> helper:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s">&#39;num_tweets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-random-records">
<h2>Getting random records<a class="headerlink" href="#getting-random-records" title="Permalink to this headline">¶</a></h2>
<p>Occasionally you may want to pull a random record from the database. You can accomplish this by ordering by the <em>random</em> or <em>rand</em> function (depending on your database):</p>
<p>Postgresql and Sqlite use the <em>Random</em> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Pick 5 lucky winners:</span>
<span class="n">LotteryNumber</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Random</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>MySQL uses <em>Rand</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Pick 5 lucky winners:</span>
<span class="n">LotterNumber</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Rand</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="paginating-records">
<h2>Paginating records<a class="headerlink" href="#paginating-records" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="api.html#SelectQuery.paginate" title="SelectQuery.paginate"><code class="xref py py-meth docutils literal"><span class="pre">paginate()</span></code></a> method makes it easy to grab a <em>page</em> or records. <a class="reference internal" href="api.html#SelectQuery.paginate" title="SelectQuery.paginate"><code class="xref py py-meth docutils literal"><span class="pre">paginate()</span></code></a> takes two parameters, <code class="docutils literal"><span class="pre">page_number</span></code>, and <code class="docutils literal"><span class="pre">items_per_page</span></code>.</p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">Page numbers are 1-based, so the first page of results will be page 1.</p>
</div>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
<span class="gp">...</span>
<span class="go">tweet 10</span>
<span class="go">tweet 11</span>
<span class="go">tweet 12</span>
<span class="go">tweet 13</span>
<span class="go">tweet 14</span>
<span class="go">tweet 15</span>
<span class="go">tweet 16</span>
<span class="go">tweet 17</span>
<span class="go">tweet 18</span>
<span class="go">tweet 19</span>
</pre></div>
</div>
<p>If you would like more granular control, you can always use <a class="reference internal" href="api.html#SelectQuery.limit" title="SelectQuery.limit"><code class="xref py py-meth docutils literal"><span class="pre">limit()</span></code></a> and <a class="reference internal" href="api.html#SelectQuery.offset" title="SelectQuery.offset"><code class="xref py py-meth docutils literal"><span class="pre">offset()</span></code></a>.</p>
</div>
<div class="section" id="counting-records">
<h2>Counting records<a class="headerlink" href="#counting-records" title="Permalink to this headline">¶</a></h2>
<p>You can count the number of rows in any select query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">100</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">50</span>
</pre></div>
</div>
<p>In some cases it may be necessary to wrap your query and apply a count to the rows of the inner query (such as when using <em>DISTINCT</em> or <em>GROUP BY</em>). Peewee will usually do this automatically, but in some cases you may need to manually call <a class="reference internal" href="api.html#SelectQuery.wrapped_count" title="SelectQuery.wrapped_count"><code class="xref py py-meth docutils literal"><span class="pre">wrapped_count()</span></code></a> instead.</p>
</div>
<div class="section" id="aggregating-records">
<h2>Aggregating records<a class="headerlink" href="#aggregating-records" title="Permalink to this headline">¶</a></h2>
<p>Suppose you have some users and want to get a list of them along with the count of tweets in each. The <a class="reference internal" href="api.html#SelectQuery.annotate" title="SelectQuery.annotate"><code class="xref py py-meth docutils literal"><span class="pre">annotate()</span></code></a> method provides a short-hand for creating these types of queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
</pre></div>
</div>
<p>The above query is equivalent to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;count&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
</pre></div>
</div>
<p>The resulting query will return <em>User</em> objects with all their normal attributes plus an additional attribute <em>count</em> which will contain the count of tweets for each user. By default it uses an inner join if the foreign key is not nullable, which means users without tweets won&#8217;t appear in the list. To remedy this, manually specify the type of join to include users with 0 tweets:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Tweet</span><span class="p">))</span>
</pre></div>
</div>
<p>You can also specify a custom aggregator, such as <em>MIN</em> or <em>MAX</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
             <span class="n">Tweet</span><span class="p">,</span>
             <span class="n">fn</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;latest_tweet_date&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Let&#8217;s assume you have a tagging application and want to find tags that have a certain number of related objects. For this example we&#8217;ll use some different models in a <a class="reference internal" href="#manytomany"><span>many-to-many</span></a> configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Photo</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PhotoTag</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Photo</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>
</pre></div>
</div>
<p>Now say we want to find tags that have at least 5 photos associated with them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tag</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PhotoTag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Photo</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<p>This query is equivalent to the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;name&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;tag&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;phototag&quot;</span> <span class="k">AS</span> <span class="n">t2</span> <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;tag_id&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;photo&quot;</span> <span class="k">AS</span> <span class="n">t3</span> <span class="k">ON</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;photo_id&quot;</span> <span class="o">=</span> <span class="n">t3</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;name&quot;</span>
<span class="k">HAVING</span> <span class="k">Count</span><span class="p">(</span><span class="n">t3</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Suppose we want to grab the associated count and store it on the tag:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tag</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;count&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PhotoTag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Photo</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Tag</span><span class="p">)</span>
         <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieving-scalar-values">
<h2>Retrieving Scalar Values<a class="headerlink" href="#retrieving-scalar-values" title="Permalink to this headline">¶</a></h2>
<p>You can retrieve scalar values by calling <a class="reference internal" href="api.html#Query.scalar" title="Query.scalar"><code class="xref py py-meth docutils literal"><span class="pre">Query.scalar()</span></code></a>. For instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">PageView</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Distinct</span><span class="p">(</span><span class="n">PageView</span><span class="o">.</span><span class="n">url</span><span class="p">)))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<span class="go">100</span>
</pre></div>
</div>
<p>You can retrieve multiple scalar values by passing <code class="docutils literal"><span class="pre">as_tuple=True</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">Employee</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">fn</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">),</span> <span class="n">fn</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="go">(30000, 50000)</span>
</pre></div>
</div>
</div>
<div class="section" id="sql-functions-subqueries-and-raw-expressions">
<h2>SQL Functions, Subqueries and &#8220;Raw expressions&#8221;<a class="headerlink" href="#sql-functions-subqueries-and-raw-expressions" title="Permalink to this headline">¶</a></h2>
<p>Suppose you need to want to get a list of all users whose username begins with <em>a</em>. There are a couple ways to do this, but one method might be to use some SQL functions like <em>LOWER</em> and <em>SUBSTR</em>. To use arbitrary SQL functions, use the special <a class="reference internal" href="api.html#fn" title="fn"><code class="xref py py-func docutils literal"><span class="pre">fn()</span></code></a> object to construct queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Select the user&#39;s id, username and the first letter of their username, lower-cased</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;first_letter&#39;</span><span class="p">))</span>

<span class="c"># Alternatively we could select only users whose username begins with &#39;a&#39;</span>
<span class="n">a_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">a_users</span><span class="p">:</span>
<span class="o">...</span>    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
</pre></div>
</div>
<p>There are times when you may want to simply pass in some arbitrary sql. You can do this using the special <a class="reference internal" href="api.html#SQL" title="SQL"><code class="xref py py-class docutils literal"><span class="pre">SQL</span></code></a> class. One use-case is when referencing an alias:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># We&#39;ll query the user table and annotate it with a count of tweets for</span>
<span class="c"># the given user</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;ct&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>

<span class="c"># Now we will order by the count, which was aliased to &quot;ct&quot;</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s">&#39;ct&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>There are two ways to execute hand-crafted SQL statements with peewee:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="api.html#Database.execute_sql" title="Database.execute_sql"><code class="xref py py-meth docutils literal"><span class="pre">Database.execute_sql()</span></code></a> for executing any type of query</li>
<li><a class="reference internal" href="api.html#RawQuery" title="RawQuery"><code class="xref py py-class docutils literal"><span class="pre">RawQuery</span></code></a> for executing <code class="docutils literal"><span class="pre">SELECT</span></code> queries and <em>returning model instances</em>.</li>
</ol>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s">&#39;:memory:&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="c"># let&#39;s pretend we want to do an &quot;upsert&quot;, something that SQLite can</span>
<span class="c"># do, but peewee cannot.</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s">&#39;REPLACE INTO person (name) VALUES (?)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>

<span class="c"># now let&#39;s iterate over the people using our own query.</span>
<span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">Person</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;select * from person&#39;</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>  <span class="c"># .raw() will return model instances.</span>
</pre></div>
</div>
</div>
<div class="section" id="security-and-sql-injection">
<h2>Security and SQL Injection<a class="headerlink" href="#security-and-sql-injection" title="Permalink to this headline">¶</a></h2>
<p>By default peewee will parameterize queries, so any parameters passed in by the user will be escaped. The only exception to this rule is if you are writing a raw SQL query or are passing in a <code class="docutils literal"><span class="pre">SQL</span></code> object which may contain untrusted data. To mitigate this, ensure that any user-defined data is passed in as a query parameter and not part of the actual SQL query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Bad!</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;SELECT * FROM my_table WHERE data = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_data</span><span class="p">,))</span>

<span class="c"># Good. `user_data` will be treated as a parameter to the query.</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;SELECT * FROM my_table WHERE data = </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span>

<span class="c"># Bad!</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s">&#39;Some SQL expression </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">user_data</span><span class="p">))</span>

<span class="c"># Good. `user_data` will be treated as a parameter.</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s">&#39;Some SQL expression </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">user_data</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">MySQL and Postgresql use <code class="docutils literal"><span class="pre">'%s'</span></code> to denote parameters. SQLite, on the other hand, uses <code class="docutils literal"><span class="pre">'?'</span></code>. Be sure to use the character appropriate to your database. You can also find this parameter by checking <code class="xref py py-attr docutils literal"><span class="pre">Database.interpolation</span></code>.</p>
</div>
</div>
<div class="section" id="window-functions">
<span id="id4"></span><h2>Window functions<a class="headerlink" href="#window-functions" title="Permalink to this headline">¶</a></h2>
<p>peewee comes with basic support for SQL window functions, which can be created by calling <a class="reference internal" href="api.html#fn.over" title="fn.over"><code class="xref py py-meth docutils literal"><span class="pre">fn.over()</span></code></a> and passing in your partitioning or ordering parameters.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Get the list of employees and the average salary for their dept.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Employee</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">department</span><span class="p">,</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">,</span>
             <span class="n">fn</span><span class="o">.</span><span class="n">Avg</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
                 <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">Employee</span><span class="o">.</span><span class="n">department</span><span class="p">]))</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<span class="c"># Rank employees by salary.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Employee</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">,</span>
             <span class="n">fn</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
                 <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">])))</span>
</pre></div>
</div>
<p>For general information on window functions, check out the <a class="reference external" href="http://www.postgresql.org/docs/9.1/static/tutorial-window.html">postgresql docs</a>.</p>
</div>
<div class="section" id="retrieving-raw-tuples-dictionaries">
<h2>Retrieving raw tuples / dictionaries<a class="headerlink" href="#retrieving-raw-tuples-dictionaries" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you do not need the overhead of creating model instances and simply want to iterate over the row tuples. To do this, call <a class="reference internal" href="api.html#SelectQuery.tuples" title="SelectQuery.tuples"><code class="xref py py-meth docutils literal"><span class="pre">SelectQuery.tuples()</span></code></a> or <a class="reference internal" href="api.html#RawQuery.tuples" title="RawQuery.tuples"><code class="xref py py-meth docutils literal"><span class="pre">RawQuery.tuples()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stats</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">tuples</span><span class="p">()</span>

<span class="c"># iterate over a list of 2-tuples containing the url and count</span>
<span class="k">for</span> <span class="n">stat_url</span><span class="p">,</span> <span class="n">stat_count</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">stat_url</span><span class="p">,</span> <span class="n">stat_count</span>
</pre></div>
</div>
<p>Similarly, you can return the rows from the cursor as dictionaries using <a class="reference internal" href="api.html#SelectQuery.dicts" title="SelectQuery.dicts"><code class="xref py py-meth docutils literal"><span class="pre">SelectQuery.dicts()</span></code></a> or <a class="reference internal" href="api.html#RawQuery.dicts" title="RawQuery.dicts"><code class="xref py py-meth docutils literal"><span class="pre">RawQuery.dicts()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stats</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;ct&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>

<span class="c"># iterate over a list of 2-tuples containing the url and count</span>
<span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">stat</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="s">&#39;ct&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="query-operators">
<span id="id5"></span><h1>Query operators<a class="headerlink" href="#query-operators" title="Permalink to this headline">¶</a></h1>
<p>The following types of comparisons are supported by peewee:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Comparison</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">==</span></code></td>
<td>x equals y</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&lt;</span></code></td>
<td>x is less than y</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&lt;=</span></code></td>
<td>x is less than or equal to y</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&gt;</span></code></td>
<td>x is greater than y</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&gt;=</span></code></td>
<td>x is greater than or equal to y</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">!=</span></code></td>
<td>x is not equal to y</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&lt;&lt;</span></code></td>
<td>x IN y, where y is a list or query</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&gt;&gt;</span></code></td>
<td>x IS y, where y is None/NULL</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">%</span></code></td>
<td>x LIKE y where y may contain wildcards</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">**</span></code></td>
<td>x ILIKE y where y may contain wildcards</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">~</span></code></td>
<td>Negation</td>
</tr>
</tbody>
</table>
<p>Because I ran out of operators to override, there are some additional query operations available as methods:</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">.contains(substr)</span></code></td>
<td>Wild-card search for substring.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">.startswith(prefix)</span></code></td>
<td>Search for values beginning with <code class="docutils literal"><span class="pre">prefix</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">.endswith(suffix)</span></code></td>
<td>Search for values ending with <code class="docutils literal"><span class="pre">suffix</span></code>.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">.between(low,</span> <span class="pre">high)</span></code></td>
<td>Search for values between <code class="docutils literal"><span class="pre">low</span></code> and <code class="docutils literal"><span class="pre">high</span></code>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">.regexp(exp)</span></code></td>
<td>Regular expression match.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">.bin_and(value)</span></code></td>
<td>Binary AND.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">.bin_or(value)</span></code></td>
<td>Binary OR.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">.in_(value)</span></code></td>
<td>IN lookup (identical to <code class="docutils literal"><span class="pre">&lt;&lt;</span></code>).</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">.not_in(value)</span></code></td>
<td>NOT IN lookup.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">.is_null(is_null)</span></code></td>
<td>IS NULL or IS NOT NULL. Accepts boolean param.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">.concat(other)</span></code></td>
<td>Concatenate two strings using <code class="docutils literal"><span class="pre">||</span></code>.</td>
</tr>
</tbody>
</table>
<p>To combine clauses using logical operators, use:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="22%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operator</th>
<th class="head">Meaning</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&amp;</span></code></td>
<td>AND</td>
<td><code class="docutils literal"><span class="pre">(User.is_active</span> <span class="pre">==</span> <span class="pre">True)</span> <span class="pre">&amp;</span> <span class="pre">(User.is_admin</span> <span class="pre">==</span> <span class="pre">True)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">|</span></code> (pipe)</td>
<td>OR</td>
<td><code class="docutils literal"><span class="pre">(User.is_admin)</span> <span class="pre">|</span> <span class="pre">(User.is_superuser)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">~</span></code></td>
<td>NOT (unary negation)</td>
<td><code class="docutils literal"><span class="pre">~(User.username</span> <span class="pre">&lt;&lt;</span> <span class="pre">['foo',</span> <span class="pre">'bar',</span> <span class="pre">'baz'])</span></code></td>
</tr>
</tbody>
</table>
<p>Here is how you might use some of these query operators:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Find the user whose username is &quot;charlie&quot;.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span>

<span class="c"># Find the users whose username is in [charlie, huey, mickey]</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">])</span>

<span class="n">Employee</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">60000</span><span class="p">))</span>

<span class="n">Employee</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">))</span>

<span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">search_string</span><span class="p">))</span>
</pre></div>
</div>
<p>Here is how you might combine expressions. Comparisons can be arbitrarily
complex.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that the actual comparisons are wrapped in parentheses. Python&#8217;s operator
precedence necessitates that comparisons be wrapped in parentheses.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Find any users who are active administrations.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
  <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span>
  <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>

<span class="c"># Find any users who are either administrators or super-users.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
  <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span>
  <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>

<span class="c"># Find any Tweets by users who are not admins (NOT IN).</span>
<span class="n">admins</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">non_admin_tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
  <span class="o">~</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">&lt;&lt;</span> <span class="n">admins</span><span class="p">))</span>

<span class="c"># Find any users who are not my friends (strangers).</span>
<span class="n">friends</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
  <span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">])</span>
<span class="n">strangers</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="n">friends</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Although you may be tempted to use python&#8217;s <code class="docutils literal"><span class="pre">in</span></code>, <code class="docutils literal"><span class="pre">and</span></code>, <code class="docutils literal"><span class="pre">or</span></code> and
<code class="docutils literal"><span class="pre">not</span></code> operators in your query expressions, these <strong>will not work.</strong> The
return value of an <code class="docutils literal"><span class="pre">in</span></code> expression is always coerced to a boolean value.
Similarly, <code class="docutils literal"><span class="pre">and</span></code>, <code class="docutils literal"><span class="pre">or</span></code> and <code class="docutils literal"><span class="pre">not</span></code> all treat their arguments as boolean
values and cannot be overloaded.</p>
<p>So just remember:</p>
<ul class="last simple">
<li>Use <code class="docutils literal"><span class="pre">&lt;&lt;</span></code> instead of <code class="docutils literal"><span class="pre">in</span></code></li>
<li>Use <code class="docutils literal"><span class="pre">&amp;</span></code> instead of <code class="docutils literal"><span class="pre">and</span></code></li>
<li>Use <code class="docutils literal"><span class="pre">|</span></code> instead of <code class="docutils literal"><span class="pre">or</span></code></li>
<li>Use <code class="docutils literal"><span class="pre">~</span></code> instead of <code class="docutils literal"><span class="pre">not</span></code></li>
<li>Don&#8217;t forget to wrap your comparisons in parentheses when using logical
operators.</li>
</ul>
</div>
<p>For more examples, see the <a class="reference internal" href="#expressions"><span>Expressions</span></a> section.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>LIKE and ILIKE with SQLite</strong></p>
<p class="last">Because SQLite&#8217;s <code class="docutils literal"><span class="pre">LIKE</span></code> operation is case-insensitive by default,
peewee will use the SQLite <code class="docutils literal"><span class="pre">GLOB</span></code> operation for case-sensitive searches.
The glob operation uses asterisks for wildcards as opposed to the usual
percent-sign. If you are using SQLite and want case-sensitive partial
string matching, remember to use asterisks for the wildcard.</p>
</div>
<div class="section" id="three-valued-logic">
<h2>Three valued logic<a class="headerlink" href="#three-valued-logic" title="Permalink to this headline">¶</a></h2>
<p>Because of the way SQL handles <code class="docutils literal"><span class="pre">NULL</span></code>, there are some special operations available for expressing:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">IS</span> <span class="pre">NULL</span></code></li>
<li><code class="docutils literal"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code></li>
<li><code class="docutils literal"><span class="pre">IN</span></code></li>
<li><code class="docutils literal"><span class="pre">NOT</span> <span class="pre">IN</span></code></li>
</ul>
<p>While it would be possible to use the <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal"><span class="pre">IN</span></code> operators with the negation operator (<code class="docutils literal"><span class="pre">~</span></code>), sometimes to get the correct semantics you will need to explicitly use <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code> and <code class="docutils literal"><span class="pre">NOT</span> <span class="pre">IN</span></code>.</p>
<p>The simplest way to use <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal"><span class="pre">IN</span></code> is to use the operator overloads:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Get all User objects whose last login is NULL.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span> <span class="o">&gt;&gt;</span> <span class="bp">None</span><span class="p">)</span>

<span class="c"># Get users whose username is in the given list.</span>
<span class="n">usernames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">]</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">&lt;&lt;</span> <span class="n">usernames</span><span class="p">)</span>
</pre></div>
</div>
<p>If you don&#8217;t like operator overloads, you can call the Field methods instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Get all User objects whose last login is NULL.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span><span class="o">.</span><span class="n">is_null</span><span class="p">(</span><span class="bp">True</span><span class="p">))</span>

<span class="c"># Get users whose username is in the given list.</span>
<span class="n">usernames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">]</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">usernames</span><span class="p">))</span>
</pre></div>
</div>
<p>To negate the above queries, you can use unary negation, but for the correct semantics you may need to use the special <code class="docutils literal"><span class="pre">IS</span> <span class="pre">NOT</span></code> and <code class="docutils literal"><span class="pre">NOT</span> <span class="pre">IN</span></code> operators:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Get all User objects whose last login is *NOT* NULL.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span><span class="o">.</span><span class="n">is_null</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>

<span class="c"># Using unary negation instead.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span> <span class="o">&gt;&gt;</span> <span class="bp">None</span><span class="p">))</span>

<span class="c"># Get users whose username is *NOT* in the given list.</span>
<span class="n">usernames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">]</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">not_in</span><span class="p">(</span><span class="n">usernames</span><span class="p">))</span>

<span class="c"># Using unary negation instead.</span>
<span class="n">usernames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">]</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">&lt;&lt;</span> <span class="n">usernames</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-user-defined-operators">
<span id="custom-operators"></span><h2>Adding user-defined operators<a class="headerlink" href="#adding-user-defined-operators" title="Permalink to this headline">¶</a></h2>
<p>Because I ran out of python operators to overload, there are some missing operators in peewee, for instance <a class="reference external" href="https://github.com/coleifer/peewee/issues/177">modulo</a>. If you find that you need to support an operator that is not in the table above, it is very easy to add your own.</p>
<p>Here is how you might add support for <code class="docutils literal"><span class="pre">modulo</span></code> in SQLite:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="n">Expression</span> <span class="c"># the building block for expressions</span>

<span class="n">OP</span><span class="p">[</span><span class="s">&#39;MOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;mod&#39;</span>

<span class="k">def</span> <span class="nf">mod</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">OP</span><span class="o">.</span><span class="n">MOD</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

<span class="n">SqliteDatabase</span><span class="o">.</span><span class="n">register_ops</span><span class="p">({</span><span class="n">OP</span><span class="o">.</span><span class="n">MOD</span><span class="p">:</span> <span class="s">&#39;%&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Now you can use these custom operators to build richer queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Users with even ids.</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mod</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>For more examples check out the source to the <code class="docutils literal"><span class="pre">playhouse.postgresql_ext</span></code> module, as it contains numerous operators specific to postgresql&#8217;s hstore.</p>
</div>
<div class="section" id="expressions">
<span id="id6"></span><h2>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">¶</a></h2>
<p>Peewee is designed to provide a simple, expressive, and pythonic way of constructing SQL queries. This section will provide a quick overview of some common types of expressions.</p>
<p>There are two primary types of objects that can be composed to create expressions:</p>
<ul class="simple">
<li><code class="xref py py-class docutils literal"><span class="pre">Field</span></code> instances</li>
<li>SQL aggregations and functions using <a class="reference internal" href="api.html#fn" title="fn"><code class="xref py py-class docutils literal"><span class="pre">fn</span></code></a></li>
</ul>
<p>We will assume a simple &#8220;User&#8221; model with fields for username and other things.
It looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">last_login</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">failed_logins</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
</pre></div>
</div>
<p>Comparisons use the <a class="reference internal" href="#query-operators"><span>Query operators</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># username is equal to &#39;charlie&#39;</span>
<span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span>

<span class="c"># user has logged in less than 5 times</span>
<span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">&lt;</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Comparisons can be combined using bitwise <em>and</em> and <em>or</em>.  Operator precedence is controlled by python and comparisons can be nested to an arbitrary depth:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># User is both and admin and has logged in today</span>
<span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span> <span class="o">&gt;=</span> <span class="n">today</span><span class="p">)</span>

<span class="c"># User&#39;s username is either charlie or charles</span>
<span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charles&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Comparisons can be used with functions as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># user&#39;s username starts with a &#39;g&#39; or a &#39;G&#39;:</span>
<span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;g&#39;</span>
</pre></div>
</div>
<p>We can do some fairly interesting things, as expressions can be compared against
other expressions.  Expressions also support arithmetic operations:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># users who entered the incorrect more than half the time and have logged</span>
<span class="c"># in at least 10 times</span>
<span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">failed_logins</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Expressions allow us to do atomic updates:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># when a user logs in we want to increment their login count:</span>
<span class="n">User</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">login_count</span><span class="o">=</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>
</pre></div>
</div>
<p>Expressions can be used in all parts of a query, so experiment!</p>
</div>
</div>
<div class="section" id="foreign-keys">
<h1>Foreign Keys<a class="headerlink" href="#foreign-keys" title="Permalink to this headline">¶</a></h1>
<p>Foreign keys are created using a special field class <a class="reference internal" href="api.html#ForeignKeyField" title="ForeignKeyField"><code class="xref py py-class docutils literal"><span class="pre">ForeignKeyField</span></code></a>. Each foreign key also creates a back-reference on the related model using the specified <em>related_name</em>.</p>
<div class="section" id="traversing-foreign-keys">
<h2>Traversing foreign keys<a class="headerlink" href="#traversing-foreign-keys" title="Permalink to this headline">¶</a></h2>
<p>Referring back to the <a class="reference internal" href="models.html#blog-models"><span>User and Tweet models</span></a>, note that there is a <a class="reference internal" href="api.html#ForeignKeyField" title="ForeignKeyField"><code class="xref py py-class docutils literal"><span class="pre">ForeignKeyField</span></code></a> from <em>Tweet</em> to <em>User</em>. The foreign key can be traversed, allowing you access to the associated user instance:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
<span class="go">&#39;charlie&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unless the <em>User</em> model was explicitly selected when retrieving the <em>Tweet</em>, an additional query will be required to load the <em>User</em> data. To learn how to avoid the extra query, see the <a class="reference internal" href="#nplusone"><span>N+1 query documentation</span></a>.</p>
</div>
<p>The reverse is also true, and we can iterate over the tweets associated with a given <em>User</em> instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
<span class="gp">...</span>
<span class="go">http://www.youtube.com/watch?v=xdhLQCYQ-nQ</span>
</pre></div>
</div>
<p>Under the hood, the <em>tweets</em> attribute is just a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> with the <em>WHERE</em> clause pre-populated to point to the given <em>User</em> instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">tweets</span>
<span class="go">&lt;class &#39;twx.Tweet&#39;&gt; SELECT t1.&quot;id&quot;, t1.&quot;user_id&quot;, t1.&quot;message&quot;, ...</span>
</pre></div>
</div>
</div>
<div class="section" id="joining-tables">
<h2>Joining tables<a class="headerlink" href="#joining-tables" title="Permalink to this headline">¶</a></h2>
<p>Use the <a class="reference internal" href="api.html#Query.join" title="Query.join"><code class="xref py py-meth docutils literal"><span class="pre">join()</span></code></a> method to <em>JOIN</em> additional tables. When a foreign key exists between the source model and the join model, you do not need to specify any additional parameters:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">my_tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>By default peewee will use an <em>INNER</em> join, but you can use <em>LEFT OUTER</em> or <em>FULL</em> joins as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;num_tweets&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;has created&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">num_tweets</span><span class="p">,</span> <span class="s">&#39;tweet(s).&#39;</span>
</pre></div>
</div>
<div class="section" id="multiple-foreign-keys-to-the-same-model">
<h3>Multiple Foreign Keys to the Same Model<a class="headerlink" href="#multiple-foreign-keys-to-the-same-model" title="Permalink to this headline">¶</a></h3>
<p>When there are multiple foreign keys to the same model, it is good practice to explicitly specify which field you are joining on.</p>
<p>Referring back to the <a class="reference internal" href="example.html#example-app-models"><span>example app&#8217;s models</span></a>, consider the <em>Relationship</em> model, which is used to denote when one user follows another. Here is the model definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">from_user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;relationships&#39;</span><span class="p">)</span>
    <span class="n">to_user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;related_to&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c"># Specify a unique multi-column index on from/to-user.</span>
            <span class="p">((</span><span class="s">&#39;from_user&#39;</span><span class="p">,</span> <span class="s">&#39;to_user&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>Since there are two foreign keys to <em>User</em>, we should always specify which field we are using in a join.</p>
<p>For example, to determine which users I am following, I would write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">User</span>
<span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">Relationship</span><span class="o">.</span><span class="n">to_user</span><span class="p">)</span>
<span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">from_user</span> <span class="o">==</span> <span class="n">charlie</span><span class="p">))</span>
</pre></div>
</div>
<p>On the other hand, if I wanted to determine which users are following me, I would instead join on the <em>from_user</em> column and filter on the relationship&#8217;s <em>to_user</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">User</span>
<span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Relationship</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">Relationship</span><span class="o">.</span><span class="n">from_user</span><span class="p">)</span>
<span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">to_user</span> <span class="o">==</span> <span class="n">charlie</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="joining-on-arbitrary-fields">
<h3>Joining on arbitrary fields<a class="headerlink" href="#joining-on-arbitrary-fields" title="Permalink to this headline">¶</a></h3>
<p>If a foreign key does not exist between two tables you can still perform a join, but you must manually specify the join predicate.</p>
<p>In the following example, there is no explicit foreign-key between <em>User</em> and <em>ActivityLog</em>, but there is an implied relationship between the <em>ActivityLog.object_id</em> field and <em>User.id</em>. Rather than joining on a specific <code class="xref py py-class docutils literal"><span class="pre">Field</span></code>, we will join using an <code class="xref py py-class docutils literal"><span class="pre">Expression</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">user_log</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">ActivityLog</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">ActivityLog</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ActivityLog</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">ActivityLog</span><span class="o">.</span><span class="n">activity_type</span> <span class="o">==</span> <span class="s">&#39;user_activity&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_log</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">description</span>

<span class="c">#### Print something like ####</span>
<span class="n">charlie</span> <span class="n">logged</span> <span class="ow">in</span>
<span class="n">charlie</span> <span class="n">posted</span> <span class="n">a</span> <span class="n">tweet</span>
<span class="n">charlie</span> <span class="n">retweeted</span>
<span class="n">charlie</span> <span class="n">posted</span> <span class="n">a</span> <span class="n">tweet</span>
<span class="n">charlie</span> <span class="n">logged</span> <span class="n">out</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>By specifying an alias on the join condition, you can control the attribute peewee will assign the joined instance to. In the previous example, we used the following <em>join</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ActivityLog</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then when iterating over the query, we were able to directly access the joined <em>ActivityLog</em> without incurring an additional query:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_log</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">description</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="joining-on-multiple-tables">
<h3>Joining on Multiple Tables<a class="headerlink" href="#joining-on-multiple-tables" title="Permalink to this headline">¶</a></h3>
<p>When calling <a class="reference internal" href="api.html#Query.join" title="Query.join"><code class="xref py py-meth docutils literal"><span class="pre">join()</span></code></a>, peewee will use the <em>last joined table</em> as the source table. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Comment</span><span class="p">)</span>
</pre></div>
</div>
<p>This query will result in a join from <em>User</em> to <em>Tweet</em>, and another join from <em>Tweet</em> to <em>Comment</em>.</p>
<p>If you would like to join the same table twice, use the <a class="reference internal" href="api.html#Query.switch" title="Query.switch"><code class="xref py py-meth docutils literal"><span class="pre">switch()</span></code></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Join the Artist table on both `Ablum` and `Genre`.</span>
<span class="n">Artist</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Album</span><span class="p">)</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">Artist</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Genre</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="implementing-many-to-many">
<span id="manytomany"></span><h2>Implementing Many to Many<a class="headerlink" href="#implementing-many-to-many" title="Permalink to this headline">¶</a></h2>
<p>Peewee does not provide a <em>field</em> for many to many relationships the way that django does &#8211; this is because the field really is hiding an intermediary table.  To implement many-to-many with peewee, you will therefore create the intermediary table yourself and query through it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Course</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">StudentCourse</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">student</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Course</span><span class="p">)</span>
</pre></div>
</div>
<p>To query, let&#8217;s say we want to find students who are enrolled in math class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Student</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">StudentCourse</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Course</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;math&#39;</span><span class="p">))</span>
<span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">student</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>To query what classes a given student is enrolled in:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">courses</span> <span class="o">=</span> <span class="p">(</span><span class="n">Course</span>
    <span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">StudentCourse</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;da vinci&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">courses</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">course</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>To efficiently iterate over a many-to-many relation, i.e., list all students and their respective courses, we will query the <em>through</em> model <code class="docutils literal"><span class="pre">StudentCourse</span></code> and <em>precompute</em> the Student and Course:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">StudentCourse</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">StudentCourse</span><span class="p">,</span> <span class="n">Student</span><span class="p">,</span> <span class="n">Course</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Course</span><span class="p">)</span>
         <span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">StudentCourse</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
<p>To print a list of students and their courses you might do the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">last</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">student_course</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="n">student</span> <span class="o">=</span> <span class="n">student_course</span><span class="o">.</span><span class="n">student</span>
    <span class="k">if</span> <span class="n">student</span> <span class="o">!=</span> <span class="n">last</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">student</span>
        <span class="k">print</span> <span class="s">&#39;Student: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">student</span><span class="o">.</span><span class="n">name</span>
    <span class="k">print</span> <span class="s">&#39;    - </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">student_course</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Since we selected all fields from <code class="docutils literal"><span class="pre">Student</span></code> and <code class="docutils literal"><span class="pre">Course</span></code> in the <em>select</em> clause of the query, these foreign key traversals are &#8220;free&#8221; and we&#8217;ve done the whole iteration with just 1 query.</p>
<div class="section" id="manytomanyfield">
<h3>ManyToManyField<a class="headerlink" href="#manytomanyfield" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="playhouse.html#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a> provides a <em>field-like</em> API over many-to-many fields. For all but the simplest many-to-many situations, you&#8217;re better off using the standard peewee APIs. But, if your models are very simple and your querying needs are not very complex, you can get a big boost by using <a class="reference internal" href="playhouse.html#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a>. Check out the <a class="reference internal" href="playhouse.html#shortcuts"><span>Shortcuts</span></a> extension module for details.</p>
<p>Modeling students and courses using <a class="reference internal" href="playhouse.html#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">playhouse.shortcuts</span> <span class="kn">import</span> <span class="n">ManyToManyField</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s">&#39;school.db&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Course</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Student</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;courses&#39;</span><span class="p">)</span>

<span class="n">StudentCourse</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">get_through_model</span><span class="p">()</span>

<span class="n">db</span><span class="o">.</span><span class="n">create_tables</span><span class="p">([</span>
    <span class="n">Student</span><span class="p">,</span>
    <span class="n">Course</span><span class="p">,</span>
    <span class="n">StudentCourse</span><span class="p">])</span>

<span class="c"># Get all classes that &quot;huey&quot; is enrolled in:</span>
<span class="n">huey</span> <span class="o">=</span> <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Huey&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">course</span><span class="o">.</span><span class="n">name</span>

<span class="c"># Get all students in &quot;English 101&quot;:</span>
<span class="n">engl_101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;English 101&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">engl_101</span><span class="o">.</span><span class="n">students</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">student</span><span class="o">.</span><span class="n">name</span>

<span class="c"># When adding objects to a many-to-many relationship, we can pass</span>
<span class="c"># in either a single model instance, a list of models, or even a</span>
<span class="c"># query of models:</span>
<span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&#39;English&#39;</span><span class="p">)))</span>

<span class="n">engl_101</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Mickey&#39;</span><span class="p">))</span>
<span class="n">engl_101</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">add</span><span class="p">([</span>
    <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Charlie&#39;</span><span class="p">),</span>
    <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Zaizee&#39;</span><span class="p">)])</span>

<span class="c"># The same rules apply for removing items from a many-to-many:</span>
<span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;CS&#39;</span><span class="p">)))</span>

<span class="n">engl_101</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">huey</span><span class="p">)</span>

<span class="c"># Calling .clear() will remove all associated objects:</span>
<span class="n">cs_150</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<p>For more examples, see:</p>
<ul class="simple">
<li><a class="reference internal" href="playhouse.html#ManyToManyField.add" title="ManyToManyField.add"><code class="xref py py-meth docutils literal"><span class="pre">ManyToManyField.add()</span></code></a></li>
<li><a class="reference internal" href="playhouse.html#ManyToManyField.remove" title="ManyToManyField.remove"><code class="xref py py-meth docutils literal"><span class="pre">ManyToManyField.remove()</span></code></a></li>
<li><a class="reference internal" href="playhouse.html#ManyToManyField.clear" title="ManyToManyField.clear"><code class="xref py py-meth docutils literal"><span class="pre">ManyToManyField.clear()</span></code></a></li>
<li><a class="reference internal" href="playhouse.html#ManyToManyField.get_through_model" title="ManyToManyField.get_through_model"><code class="xref py py-meth docutils literal"><span class="pre">ManyToManyField.get_through_model()</span></code></a></li>
</ul>
</div>
</div>
<div class="section" id="self-joins">
<h2>Self-joins<a class="headerlink" href="#self-joins" title="Permalink to this headline">¶</a></h2>
<p>Peewee supports several methods for constructing queries containing a self-join.</p>
<div class="section" id="using-model-aliases">
<h3>Using model aliases<a class="headerlink" href="#using-model-aliases" title="Permalink to this headline">¶</a></h3>
<p>To join on the same model (table) twice, it is necessary to create a model alias to represent the second instance of the table in a query. Consider the following model:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;children&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>What if we wanted to query all categories whose parent category is <em>Electronics</em>. One way would be to perform a self-join:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Parent</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Category</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Parent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">Parent</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Electronics&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>When performing a join that uses a <code class="xref py py-class docutils literal"><span class="pre">ModelAlias</span></code>, it is necessary to specify the join condition using the <code class="docutils literal"><span class="pre">on</span></code> keyword argument. In this case we are joining the category with its parent category.</p>
</div>
<div class="section" id="using-subqueries">
<h3>Using subqueries<a class="headerlink" href="#using-subqueries" title="Permalink to this headline">¶</a></h3>
<p>Another less common approach involves the use of subqueries. Here is another way we might construct a query to get all the categories whose parent category is <em>Electronics</em> using a subquery:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">join_query</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Electronics&#39;</span><span class="p">)</span>

<span class="c"># Subqueries used as JOINs need to have an alias.</span>
<span class="n">join_query</span> <span class="o">=</span> <span class="n">join_query</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;jq&#39;</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Category</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">join_query</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">join_query</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span>
</pre></div>
</div>
<p>This will generate the following SQL query:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;name&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;parent_id&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;category&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">t3</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
  <span class="k">FROM</span> <span class="ss">&quot;category&quot;</span> <span class="k">AS</span> <span class="n">t3</span>
  <span class="k">WHERE</span> <span class="p">(</span><span class="n">t3</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">jq</span> <span class="k">ON</span> <span class="p">(</span><span class="n">t1</span><span class="p">.</span><span class="ss">&quot;parent_id&quot;</span> <span class="o">=</span> <span class="ss">&quot;jq&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
</pre></div>
</div>
<p>To access the <code class="docutils literal"><span class="pre">id</span></code> value from the subquery, we use the <code class="docutils literal"><span class="pre">.c</span></code> magic lookup which will generate the appropriate SQL expression:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Category</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">join_query</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span>
<span class="c"># Becomes: (t1.&quot;parent_id&quot; = &quot;jq&quot;.&quot;id&quot;)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="performance-techniques">
<h1>Performance Techniques<a class="headerlink" href="#performance-techniques" title="Permalink to this headline">¶</a></h1>
<p>This section outlines some techniques for improving performance when using peewee.</p>
<div class="section" id="avoiding-n-1-queries">
<span id="nplusone"></span><h2>Avoiding N+1 queries<a class="headerlink" href="#avoiding-n-1-queries" title="Permalink to this headline">¶</a></h2>
<p>The term <em>N+1 queries</em> refers to a situation where an application performs a query, then for each row of the result set, the application performs at least one other query (another way to conceptualize this is as a nested loop). In many cases, these <em>n</em> queries can be avoided through the use of a SQL join or subquery. The database itself may do a nested loop, but it will usually be more performant than doing <em>n</em> queries in your application code, which involves latency communicating with the database and may not take advantage of indices or other optimizations employed by the database when joining or executing a subquery.</p>
<p>Peewee provides several APIs for mitigating <em>N+1</em> query behavior. Recollecting the models used throughout this document, <em>User</em> and <em>Tweet</em>, this section will try to outline some common <em>N+1</em> scenarios, and how peewee can help you avoid them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In some cases, N+1 queries will not result in a significant or measurable performance hit. It all depends on the data you are querying, the database you are using, and the latency involved in executing queries and retrieving results. As always when making optimizations, profile before and after to ensure the changes do what you expect them to.</p>
</div>
<div class="section" id="list-recent-tweets">
<h3>List recent tweets<a class="headerlink" href="#list-recent-tweets" title="Permalink to this headline">¶</a></h3>
<p>The twitter timeline displays a list of tweets from multiple users. In addition to the tweet&#8217;s content, the username of the tweet&#8217;s author is also displayed. The N+1 scenario here would be:</p>
<ol class="arabic simple">
<li>Fetch the 10 most recent tweets.</li>
<li>For each tweet, select the author (10 queries).</li>
</ol>
<p>By selecting both tables and using a <em>join</em>, peewee makes it possible to accomplish this in a single query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>  <span class="c"># Note that we are selecting both models.</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>  <span class="c"># Use an INNER join because every tweet has an author.</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>  <span class="c"># Get the most recent tweets.</span>
         <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
</pre></div>
</div>
<p>Without the join, accessing <code class="docutils literal"><span class="pre">tweet.user.username</span></code> would trigger a query to resolve the foreign key <code class="docutils literal"><span class="pre">tweet.user</span></code> and retrieve the associated user. But since we have selected and joined on <code class="docutils literal"><span class="pre">User</span></code>, peewee will automatically resolve the foreign-key for us.</p>
</div>
<div class="section" id="list-users-and-all-their-tweets">
<h3>List users and all their tweets<a class="headerlink" href="#list-users-and-all-their-tweets" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s say you want to build a page that shows several users and all of their tweets. The N+1 scenario would be:</p>
<ol class="arabic simple">
<li>Fetch some users.</li>
<li>For each user, fetch their tweets.</li>
</ol>
<p>This situation is similar to the previous example, but there is one important difference: when we selected tweets, they only have a single associated user, so we could directly assign the foreign key. The reverse is not true, however, as one user may have any number of tweets (or none at all).</p>
<p>Peewee provides two approaches to avoiding <em>O(n)</em> queries in this situation. We can either:</p>
<ul class="simple">
<li>Fetch users first, then fetch all the tweets associated with those users. Once peewee has the big list of tweets, it will assign them out, matching them with the appropriate user. This method is usually faster but will involve a query for each table being selected.</li>
<li>Fetch both users and tweets in a single query. User data will be duplicated, so peewee will de-dupe it and aggregate the tweets as it iterates through the result set. This method involves a lot of data being transferred over the wire and a lot of logic in Python to de-duplicate rows.</li>
</ul>
<p>Each solution has its place and, depending on the size and shape of the data you are querying, one may be more performant than the other.</p>
</div>
<div class="section" id="using-prefetch">
<span id="prefetch"></span><h3>Using prefetch<a class="headerlink" href="#using-prefetch" title="Permalink to this headline">¶</a></h3>
<p>peewee supports pre-fetching related data using sub-queries. This method requires the use of a special API, <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a>. Pre-fetch, as its name indicates, will eagerly load the appropriate tweets for the given users using subqueries. This means instead of <em>O(n)</em> queries for <em>n</em> rows, we will do <em>O(k)</em> queries for <em>k</em> tables.</p>
<p>Here is an example of how we might fetch several users and any tweets they created within the past week.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">week_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">tweets</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
          <span class="o">.</span><span class="n">select</span><span class="p">()</span>
          <span class="o">.</span><span class="n">where</span><span class="p">(</span>
              <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">is_published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span>
              <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span> <span class="o">&gt;=</span> <span class="n">week_ago</span><span class="p">)))</span>

<span class="c"># This will perform two queries.</span>
<span class="n">users_with_tweets</span> <span class="o">=</span> <span class="n">prefetch</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">tweets</span><span class="p">)</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_with_tweets</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets_prefetch</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;  &#39;</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that neither the <code class="docutils literal"><span class="pre">User</span></code> query, nor the <code class="docutils literal"><span class="pre">Tweet</span></code> query contained a
JOIN clause. When using <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a> you do not need to specify the
join.</p>
</div>
<p><a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a> can be used to query an arbitrary number of tables. Check the API documentation for more examples.</p>
<p>Some things to consider when using <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a>:</p>
<ul class="simple">
<li>Foreign keys must exist between the models being prefetched.</li>
<li>In general it is more performant than <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a>.</li>
<li>Typically a lot less data is transferred over the wire since data is not duplicated.</li>
<li>There is less Python overhead since we don&#8217;t have to de-dupe things.</li>
<li><cite>LIMIT</cite> works as you&#8217;d expect on the outer-most query, but may be difficult to implement correctly if trying to limit the size of the sub-selects.</li>
</ul>
</div>
<div class="section" id="using-aggregate-rows">
<span id="aggregate-rows"></span><h3>Using aggregate_rows<a class="headerlink" href="#using-aggregate-rows" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a> approach selects all data in one go and de-dupes things in-memory. Like <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a>, it can work with arbitrarily complex queries. To use this feature We will use a special flag, <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a>, when creating our query. This method tells peewee to de-duplicate any rows that, due to the structure of the JOINs, may be duplicated.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Because there is a lot of computation involved in de-duping data, it is possible that for some queries <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a> will be <strong>significantly less performant</strong> than using <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a> (described in the previous section) or even issuing <em>O(n)</em> simple queries! Profile your code if you&#8217;re not sure.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Tweet</span><span class="p">)</span>  <span class="c"># As in the previous example, we select both tables.</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>  <span class="c"># We need to specify an ordering here.</span>
         <span class="o">.</span><span class="n">aggregate_rows</span><span class="p">())</span>  <span class="c"># Tell peewee to de-dupe and aggregate results.</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;  &#39;</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
</pre></div>
</div>
<p>Ordinarily, <code class="docutils literal"><span class="pre">user.tweets</span></code> would be a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> and iterating over it would trigger an additional query. By using <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a>, though, <code class="docutils literal"><span class="pre">user.tweets</span></code> is a Python <code class="docutils literal"><span class="pre">list</span></code> and no additional query occurs.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We used a <em>LEFT OUTER</em> join to ensure that users with zero tweets would also be included in the result set.</p>
</div>
<p>Below is an example of how we might fetch several users and any tweets they created within the past week. Because we are filtering the tweets and the user may not have any tweets, we need our <em>WHERE</em> clause to allow <em>NULL</em> tweet IDs.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">week_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Tweet</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span>
             <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="bp">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
                 <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">is_published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span>
                 <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span> <span class="o">&gt;=</span> <span class="n">week_ago</span><span class="p">)))</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
         <span class="o">.</span><span class="n">aggregate_rows</span><span class="p">())</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;  &#39;</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
</pre></div>
</div>
<p>Some things to consider when using <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a>:</p>
<ul class="simple">
<li>You must specify an ordering for each table that is joined on so the rows can be aggregated correctly, sort of similar to <a class="reference external" href="https://docs.python.org/2/library/itertools.html#itertools.groupby">itertools.groupby</a>.</li>
<li>Do not mix calls to <a class="reference internal" href="api.html#SelectQuery.aggregate_rows" title="SelectQuery.aggregate_rows"><code class="xref py py-meth docutils literal"><span class="pre">aggregate_rows()</span></code></a> with <code class="docutils literal"><span class="pre">LIMIT</span></code> or <code class="docutils literal"><span class="pre">OFFSET</span></code> clauses, or with <a class="reference internal" href="api.html#SelectQuery.get" title="SelectQuery.get"><code class="xref py py-meth docutils literal"><span class="pre">get()</span></code></a> (which applies a <code class="docutils literal"><span class="pre">LIMIT</span> <span class="pre">1</span></code> SQL clause). Since the aggregate result set may contain more than one item due to rows being duplicated, limits can lead to incorrect behavior. Imagine you have three users, each of whom has 10 tweets. If you run a query with a <code class="docutils literal"><span class="pre">LIMIT</span> <span class="pre">5</span></code>, then you will only receive the first user and their first 5 tweets.</li>
<li>In general the Python overhead of de-duplicating data can make this method less performant than <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a>, and sometimes even less performan than simply issuing <em>O(n)</em> simple queries! When in doubt profile.</li>
<li>Because every column from every table is included in each row tuple returned by the cursor, this approach can use a lot more bandwidth than <a class="reference internal" href="api.html#prefetch" title="prefetch"><code class="xref py py-func docutils literal"><span class="pre">prefetch()</span></code></a>.</li>
</ul>
</div>
</div>
<div class="section" id="iterating-over-lots-of-rows">
<h2>Iterating over lots of rows<a class="headerlink" href="#iterating-over-lots-of-rows" title="Permalink to this headline">¶</a></h2>
<p>By default peewee will cache the rows returned when iterating of a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>. This is an optimization to allow multiple iterations as well as indexing and slicing without causing additional queries. This caching can be problematic, however, when you plan to iterate over a large number of rows.</p>
<p>To reduce the amount of memory used by peewee when iterating over a query, use the <a class="reference internal" href="api.html#SelectQuery.iterator" title="SelectQuery.iterator"><code class="xref py py-meth docutils literal"><span class="pre">iterator()</span></code></a> method. This method allows you to iterate without caching each model returned, using much less memory when iterating over large result sets.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Let&#39;s assume we&#39;ve got 10 million stat objects to dump to a csv file.</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="c"># Our imaginary serializer class</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">CSVSerializer</span><span class="p">()</span>

<span class="c"># Loop over all the stats and serialize.</span>
<span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
    <span class="n">serializer</span><span class="o">.</span><span class="n">serialize_object</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</pre></div>
</div>
<p>For simple queries you can see further speed improvements by using the <a class="reference internal" href="api.html#SelectQuery.naive" title="SelectQuery.naive"><code class="xref py py-meth docutils literal"><span class="pre">naive()</span></code></a> method. This method speeds up the construction of peewee model instances from raw cursor data. See the <a class="reference internal" href="api.html#SelectQuery.naive" title="SelectQuery.naive"><code class="xref py py-meth docutils literal"><span class="pre">naive()</span></code></a> documentation for more details on this optimization.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">naive</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
    <span class="n">serializer</span><span class="o">.</span><span class="n">serialize_object</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also see performance improvements by using the <a class="reference internal" href="api.html#SelectQuery.dicts" title="SelectQuery.dicts"><code class="xref py py-meth docutils literal"><span class="pre">dicts()</span></code></a> and <a class="reference internal" href="api.html#SelectQuery.tuples" title="SelectQuery.tuples"><code class="xref py py-meth docutils literal"><span class="pre">tuples()</span></code></a> methods.</p>
<p>When iterating over a large number of rows that contain columns from multiple tables, peewee will reconstruct the model graph for each row returned. This operation can be slow for complex graphs. To speed up model creation, you can:</p>
<ul class="simple">
<li>Call <a class="reference internal" href="api.html#SelectQuery.naive" title="SelectQuery.naive"><code class="xref py py-meth docutils literal"><span class="pre">naive()</span></code></a>, which will not construct a graph and simply patch all attributes from the row directly onto a model instance.</li>
<li>Use <a class="reference internal" href="api.html#SelectQuery.dicts" title="SelectQuery.dicts"><code class="xref py py-meth docutils literal"><span class="pre">dicts()</span></code></a> or <a class="reference internal" href="api.html#SelectQuery.tuples" title="SelectQuery.tuples"><code class="xref py py-meth docutils literal"><span class="pre">tuples()</span></code></a>.</li>
</ul>
</div>
<div class="section" id="speeding-up-bulk-inserts">
<h2>Speeding up Bulk Inserts<a class="headerlink" href="#speeding-up-bulk-inserts" title="Permalink to this headline">¶</a></h2>
<p>See the <a class="reference internal" href="#bulk-inserts"><span>Bulk inserts</span></a> section for details on speeding up bulk insert operations.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Querying</a><ul>
<li><a class="reference internal" href="#creating-a-new-record">Creating a new record</a></li>
<li><a class="reference internal" href="#bulk-inserts">Bulk inserts</a></li>
<li><a class="reference internal" href="#updating-existing-records">Updating existing records</a></li>
<li><a class="reference internal" href="#atomic-updates">Atomic updates</a></li>
<li><a class="reference internal" href="#deleting-records">Deleting records</a></li>
<li><a class="reference internal" href="#selecting-a-single-record">Selecting a single record</a></li>
<li><a class="reference internal" href="#get-or-create">Get or create</a></li>
<li><a class="reference internal" href="#selecting-multiple-records">Selecting multiple records</a></li>
<li><a class="reference internal" href="#filtering-records">Filtering records</a><ul>
<li><a class="reference internal" href="#more-query-examples">More query examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sorting-records">Sorting records</a></li>
<li><a class="reference internal" href="#getting-random-records">Getting random records</a></li>
<li><a class="reference internal" href="#paginating-records">Paginating records</a></li>
<li><a class="reference internal" href="#counting-records">Counting records</a></li>
<li><a class="reference internal" href="#aggregating-records">Aggregating records</a></li>
<li><a class="reference internal" href="#retrieving-scalar-values">Retrieving Scalar Values</a></li>
<li><a class="reference internal" href="#sql-functions-subqueries-and-raw-expressions">SQL Functions, Subqueries and &#8220;Raw expressions&#8221;</a></li>
<li><a class="reference internal" href="#security-and-sql-injection">Security and SQL Injection</a></li>
<li><a class="reference internal" href="#window-functions">Window functions</a></li>
<li><a class="reference internal" href="#retrieving-raw-tuples-dictionaries">Retrieving raw tuples / dictionaries</a></li>
</ul>
</li>
<li><a class="reference internal" href="#query-operators">Query operators</a><ul>
<li><a class="reference internal" href="#three-valued-logic">Three valued logic</a></li>
<li><a class="reference internal" href="#adding-user-defined-operators">Adding user-defined operators</a></li>
<li><a class="reference internal" href="#expressions">Expressions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#foreign-keys">Foreign Keys</a><ul>
<li><a class="reference internal" href="#traversing-foreign-keys">Traversing foreign keys</a></li>
<li><a class="reference internal" href="#joining-tables">Joining tables</a><ul>
<li><a class="reference internal" href="#multiple-foreign-keys-to-the-same-model">Multiple Foreign Keys to the Same Model</a></li>
<li><a class="reference internal" href="#joining-on-arbitrary-fields">Joining on arbitrary fields</a></li>
<li><a class="reference internal" href="#joining-on-multiple-tables">Joining on Multiple Tables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-many-to-many">Implementing Many to Many</a><ul>
<li><a class="reference internal" href="#manytomanyfield">ManyToManyField</a></li>
</ul>
</li>
<li><a class="reference internal" href="#self-joins">Self-joins</a><ul>
<li><a class="reference internal" href="#using-model-aliases">Using model aliases</a></li>
<li><a class="reference internal" href="#using-subqueries">Using subqueries</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#performance-techniques">Performance Techniques</a><ul>
<li><a class="reference internal" href="#avoiding-n-1-queries">Avoiding N+1 queries</a><ul>
<li><a class="reference internal" href="#list-recent-tweets">List recent tweets</a></li>
<li><a class="reference internal" href="#list-users-and-all-their-tweets">List users and all their tweets</a></li>
<li><a class="reference internal" href="#using-prefetch">Using prefetch</a></li>
<li><a class="reference internal" href="#using-aggregate-rows">Using aggregate_rows</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iterating-over-lots-of-rows">Iterating over lots of rows</a></li>
<li><a class="reference internal" href="#speeding-up-bulk-inserts">Speeding up Bulk Inserts</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="models.html"
                        title="previous chapter">Models and Fields</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="transactions.html"
                        title="next chapter">Transactions</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/peewee/querying.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="transactions.html" title="Transactions"
             >next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Models and Fields"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">peewee 2.6.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright charles leifer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>